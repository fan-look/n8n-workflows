<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i18n Test</title>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/dist/umd/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@8.0.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="static/js/i18next-localstorage-backend.js"></script>
    <script src="static/js/i18n-config.js"></script>
    <script src="static/js/LanguageSwitch.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; }
        .highlight { background: yellow; padding: 2px; }
    </style>
</head>
<body>
    <h1 data-i18n="common.page_title">i18n åŠŸèƒ½æµ‹è¯•</h1>
    <div id="languageSwitchContainer"></div>

    <div class="test-section">
        <h3>åŸºæœ¬ç¿»è¯‘æµ‹è¯•</h3>
        <p data-i18n="common.page_title">This should translate: <span class="highlight">common.page_title</span></p>
        <p data-i18n="common.subtitle">This should translate: <span class="highlight">common.subtitle</span></p>
        <p data-i18n="common.total">This should translate: <span class="highlight">common.total</span></p>
        <p data-i18n="common.active">This should translate: <span class="highlight">common.active</span></p>
        <p data-i18n="workflow.integrations">This should translate: <span class="highlight">workflow.integrations</span></p>
        <p data-i18n="workflow.nodes">This should translate: <span class="highlight">workflow.nodes</span></p>
        <p data-i18n="ui.loading">This should translate: <span class="highlight">ui.loading</span></p>
    </div>

    <div class="test-section">
        <h3>å ä½ç¬¦ç¿»è¯‘æµ‹è¯•</h3>
        <input type="text" data-i18n="[placeholder]search.placeholder" placeholder="This should translate">
        <button data-i18n="[title]common.toggle_theme" title="This should translate">ğŸŒ™ Theme</button>
    </div>

    <div class="test-section">
        <h3>JavaScript ç¿»è¯‘æµ‹è¯•</h3>
        <button onclick="testJSTranslations()">æµ‹è¯• JS ç¿»è¯‘</button>
        <button onclick="testPageUpdate()">æµ‹è¯•é¡µé¢æ›´æ–°</button>
        <div id="jsResults" class="result" style="display:none;"></div>
        <div id="updateResults" class="result" style="display:none;"></div>
    </div>

    <script>
        // Helper function for translations
        function t(key, fallback = '') {
            try {
                return (window.i18n?.t || window.i18next?.t)?.(key) || fallback || key;
            } catch (_) {
                return fallback || key;
            }
        }

        // Test function for JavaScript translations
        function testJSTranslations() {
            const results = document.getElementById('jsResults');
            results.style.display = 'block';

            const translations = [
                'ui.no_integrations_found',
                'ui.view_json',
                'ui.hide_diagram',
                'workflow.status',
                'workflow.enabled',
                'workflow.disabled',
                'workflow.nodes'
            ];

            let html = '<h4>JavaScript ç¿»è¯‘ç»“æœ:</h4>';
            translations.forEach(key => {
                const translation = t(key);
                html += `<p><strong>${key}:</strong> ${translation}</p>`;
            });

            results.innerHTML = html;
        }

        // Test page translation update
        function testPageUpdate() {
            const results = document.getElementById('updateResults');
            results.style.display = 'block';

            // Update page translations
            const elements = document.querySelectorAll('[data-i18n]');
            let html = '<h4>é¡µé¢ç¿»è¯‘æ›´æ–°ç»“æœ:</h4>';
            elements.forEach(el => {
                const raw = el.getAttribute('data-i18n');
                if (!raw) return;
                const parts = raw.split(';').map(s => s.trim()).filter(Boolean);
                parts.forEach(part => {
                    const match = part.match(/^\[(.+?)\](.+)$/);
                    if (match) {
                        const attr = match[1].toLowerCase();
                        const key = match[2];
                        const val = t(key) || '';
                        if (attr === 'text') {
                            el.textContent = val;
                        } else if (attr === 'html') {
                            el.innerHTML = val;
                        } else {
                            el.setAttribute(match[1], val);
                        }
                        html += `<p><strong>${key} (${attr}):</strong> ${val}</p>`;
                    } else {
                        const val = t(part) || '';
                        if (val) el.textContent = val;
                        html += `<p><strong>${part}:</strong> ${val}</p>`;
                    }
                });
            });

            results.innerHTML = html;
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize language switch
            if (window.initLanguageSwitch) {
                window.initLanguageSwitch({ containerId: 'languageSwitchContainer' });
            }

            // Initialize i18next
            if (window.i18n && window.i18n.initI18next) {
                try {
                    await window.i18n.initI18next();
                    console.log('i18n initialized successfully');

                    // Update translations after initialization
                    setTimeout(() => {
                        testPageUpdate();
                    }, 500);
                } catch (error) {
                    console.error('Failed to initialize i18n:', error);
                }
            }

            // Listen for language change events
            document.addEventListener('languageChanged', () => {
                console.log('Language changed, updating test page');
                setTimeout(() => {
                    testPageUpdate();
                }, 200);
            });
        });
    </script>
</body>
</html>