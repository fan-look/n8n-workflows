# Nginx configuration for n8n-workflows (i18n + API)
# - Production: HTTPS with reverse proxy to Node at 127.0.0.1:3000
# - Development: local reverse proxy on :8080
# - Static caching, API proxy, SSL/TLS, security headers, performance tuning
#
# Usage:
#   1) Replace your.domain.com and certificate paths for production.
#   2) If you prefer Nginx to serve static directly, set STATIC_ROOT accordingly.
#   3) Otherwise, proxy all traffic to Node which serves /static and API.

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

# ===== Events =====
events {
  worker_connections  1024;
}

# ===== HTTP Block =====
http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # Performance
  sendfile        on;
  tcp_nopush      on;
  tcp_nodelay     on;
  keepalive_timeout  65;
  types_hash_max_size 4096;
  server_tokens off;

  # Compression
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_comp_level 5;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml+rss text/javascript image/svg+xml;

  # Optional: Brotli (requires nginx brotli module)
  # brotli on;
  # brotli_comp_level 5;
  # brotli_types text/plain text/css application/json application/javascript text/xml application/xml+rss text/javascript image/svg+xml;

  # Upstream to Node app
  upstream node_app {
    # Add more servers for load balancing if needed
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
  }

  # Cache-Control mapping for static assets
  map $sent_http_content_type $static_cache_control {
    default                           "public, max-age=60";
    ~*text/css                        "public, max-age=604800";   # 7d
    ~*application/javascript          "public, max-age=604800";   # 7d
    ~*image/                          "public, max-age=604800";   # 7d
    ~*font/                           "public, max-age=604800";   # 7d
  }

  # Common proxy settings
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Connection "";
  proxy_set_header Accept-Language $http_accept_language;
  proxy_read_timeout 60s;
  proxy_send_timeout 60s;
  proxy_connect_timeout 5s;

  # ===== Development Server (local reverse proxy) =====
  # Access at http://localhost:8080/
  server {
    listen 8080;
    server_name localhost;

    # If you want Nginx to serve static directly in dev, set your local path here
    # Example: STATIC_ROOT /var/www/n8n-workflows/dist/static;
    set $STATIC_ROOT "/var/www/n8n-workflows/dist/static";

    # Static files (prefer Nginx for speed in dev)
    location /static/ {
      root $STATIC_ROOT;
      try_files $uri @backend_static;
      expires 7d;
      add_header Cache-Control $static_cache_control;
      add_header Vary "Accept-Encoding";
    }

    # Fallback to backend static when not found
    location @backend_static {
      proxy_pass http://node_app;
    }

    # API proxy
    location /api/ {
      proxy_pass http://node_app;
      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    }

    # Health check
    location /health {
      proxy_pass http://node_app/health;
    }

    # SPA routing (serve index.html)
    location / {
      root $STATIC_ROOT;
      try_files $uri /index.html;
    }

    # Security headers (basic; Node also sets CSP via helmet)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Vary "Accept-Language" always;

    client_max_body_size 20M;
    access_log /var/log/nginx/access_dev.log;
  }

  # ===== Production: Force HTTPS =====
  server {
    listen 80;
    server_name your.domain.com;
    return 301 https://$host$request_uri;
  }

  # ===== Production HTTPS Server =====
  server {
    listen 443 ssl http2;
    server_name your.domain.com;

    # SSL certs (replace with your actual paths)
    ssl_certificate     /etc/letsencrypt/live/your.domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your.domain.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256";
    ssl_prefer_server_ciphers off;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # Security headers (Node also sets CSP)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Vary "Accept-Language" always;

    # If you want Nginx to serve static directly, set the absolute path here
    set $STATIC_ROOT "/var/www/n8n-workflows/dist/static";

    # Static files with cache
    location /static/ {
      root $STATIC_ROOT;
      try_files $uri @backend_static;
      expires 7d;
      add_header Cache-Control $static_cache_control;
      add_header Vary "Accept-Encoding";
    }

    # Fallback to backend static when not found
    location @backend_static {
      proxy_pass http://node_app;
    }

    # API proxy
    location /api/ {
      proxy_pass http://node_app;
      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    }

    # Health check
    location /health {
      proxy_pass http://node_app/health;
    }

    # SPA routing (serve index.html)
    location / {
      root $STATIC_ROOT;
      try_files $uri /index.html;
    }

    # Logs & Limits
    client_max_body_size 20M;
    access_log /var/log/nginx/access_prod.log main;
    error_log  /var/log/nginx/error_prod.log warn;

    # Optional: Proxy cache (enable if needed)
    # proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:50m max_size=1g inactive=7d use_temp_path=off;
    # location /static/ {
    #   proxy_cache STATIC;
    #   proxy_cache_valid 200 301 302 7d;
    #   proxy_cache_key $scheme$proxy_host$request_uri;
    # }
  }
}