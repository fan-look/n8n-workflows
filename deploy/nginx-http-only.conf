# Nginx (HTTP-only) reverse proxy for n8n-workflows
# Domain: n8n.bingotech2022.com
# Purpose: Serve site via HTTP only (no HTTPS, no HSTS). Avoid COOP/COEP/OAC headers.
# Notes:
# - Proxies all traffic to Node at 127.0.0.1:3000
# - Optionally serve /static directly for better performance
# - Ensure backend (Node) handles CORS; this config avoids HSTS and HTTPS redirects

# ===== Upstream to Node app =====
upstream node_app {
  server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
  keepalive 32;
}

# ===== Cache-Control mapping for static assets =====
map $sent_http_content_type $static_cache_control {
  default                           "public, max-age=60";
  ~*text/css                        "public, max-age=604800";   # 7d
  ~*application/javascript          "public, max-age=604800";   # 7d
  ~*image/                          "public, max-age=604800";   # 7d
  ~*font/                           "public, max-age=604800";   # 7d
}

# ===== HTTP Server (no SSL) =====
server {
  listen 80;
  server_name n8n.bingotech2022.com;

  # Logs & limits
  client_max_body_size 20M;
  access_log /var/log/nginx/n8n_http_access.log;
  error_log  /var/log/nginx/n8n_http_error.log warn;

  # Basic security headers (non-HTTPS)
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header Vary "Accept-Language" always;
  # IMPORTANT: Do NOT add HSTS here (Strict-Transport-Security); this is HTTP-only
  # Also avoid COOP/COEP/OAC headers on HTTP

  # Common proxy settings
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme; # will be http
  proxy_set_header Connection "";
  proxy_set_header Accept-Language $http_accept_language;
  proxy_read_timeout 60s;
  proxy_send_timeout 60s;
  proxy_connect_timeout 5s;

  # If you want Nginx to serve static directly, set the absolute path here
  # and sync your build output (dist/static) to that path on the server.
  # Otherwise, backend will serve static via the fallback.
  set $STATIC_ROOT "/var/www/n8n-workflows/dist/static";

  # Static files (prefer Nginx for speed; fallback to backend if not found)
  location /static/ {
    root $STATIC_ROOT;
    try_files $uri @backend_static;
    expires 7d;
    add_header Cache-Control $static_cache_control;
    add_header Vary "Accept-Encoding";
  }

  # Fallback to backend static when not found
  location @backend_static {
    proxy_pass http://node_app;
  }

  # API proxy
  location /api/ {
    proxy_pass http://node_app;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
  }

  # Health check
  location /health {
    proxy_pass http://node_app/health;
  }

  # SPA routing (serve index.html)
  location / {
    root $STATIC_ROOT;
    try_files $uri /index.html;
  }
}